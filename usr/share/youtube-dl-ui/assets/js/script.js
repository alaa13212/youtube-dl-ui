// Generated by CoffeeScript 1.6.3
(function() {"use strict";
	var $console, $showMore, alertBox, consoleLog, dl, fs, gui, home, lastbar, progressBar, youtubedl;

	gui = require('nw.gui');

	fs = require('fs');

	youtubedl = require('./assets/js/youtube-dl.js');

	home = process.env.HOME;

	lastbar = dl = null;

	$console = $('#console');

	$showMore = $('#show-more');

	this.mainWin = gui.Window.get();

	this.mainWin.on('close', function() {
		var _ref;
		if (( _ref = window.dragWin) != null) {
			_ref.close();
		}
		return this.close(true);
	});

	consoleLog = function(data, dir) {
		var ep, p;
		if (dir == null) {
			dir = "ltr";
		}
		p = "<p class=\"" + dir + "\">";
		ep = '</p>';
		return $console.append("" + p + data + ep).scrollTop($console[0].scrollHeight);
	};

	alertBox = function(title, text, type) {
		return $('.tmpalert').clone().removeClass("tmpalert").addClass("alert-" + type).append("<b>" + title + ": </b> " + text).appendTo($('#log')).slideDown();
	};

	progressBar = function(name) {
		return $('.tmpprogress').clone().removeClass('tmpprogress').appendTo($('#log')).slideDown().children('.bar').append("<b>" + name + "</b>");
	};

	$(document).ready(function() {
		$('#path-text').val(home);
		$('#path').change(function() {
			return $('#path-text').val($(this).val() || $('#path-text').val() || home);
		}).prop('nwworkingdir', home);
		$('#path-btn').click(function() {
			return $('#path').click();
		});
		$(document.body).on('click', '.close', function() {
			return $(this).parent('.alert').slideUp();
		});
		$('#stop').click(function() {
			$('#start').prop('disabled', false);
			$('#stop').prop('disabled', true);
			if (lastbar != null) {
				lastbar.addClass('bar-danger').parent('.progress').removeClass('active progress-striped work');
			}
			if (dl != null) {
				dl.kill();
			}
			if (dl != null) {
				return dl = null;
			}
		});
		$('#parm').submit(function(e) {
			var dlFormats, path, url;
			e.preventDefault();
			if (dl != null) {
				return alert('هناك عملية تحميل أخرى حاليا');
			}
			$('#start').prop('disabled', true);
			$('#stop').prop('disabled', false);
			url = $('#url').val();
			path = $('#path-text').val() || home;
			dlFormats = getFormats();
			if ($showMore.is('.active') && dlFormats.length !== 0) {
				dl = youtubedl.download(url, path, ['-f', dlFormats.join('/')]);
			} else {
				dl = youtubedl.download(url, path);
			}
			dl.on('log', function(d) {
				return consoleLog(d);
			});
			dl.on('palylist', function(p) {
				return alertBox('بدأ تحميل قائمة التشغيل', "" + p.name + "، " + p.length + " من الفيديوهات");
			});
			dl.on('start-vid', function(v) {
				return lastbar = progressBar(v.name);
			});
			dl.on('exec-vid', function(v) {
				return alertBox("الفيديو " + v.name + " موجود بالفعل", '', 'success');
			});
			dl.on('download', function(v) {
				if (lastbar != null) {
					lastbar.width(v.complete);
				}
				return consoleLog("السرعة: " + v.speed + "، الوقت المتبقي: " + v.time, 'rtl');
			});
			dl.on('end-vid', function(v) {
				return lastbar != null ? lastbar.width('100%').addClass('bar-success').parent('.progress').removeClass('active progress-striped work') :
				void 0;
			});
			return dl.on('close', function(code) {
				$('#start').prop('disabled', false);
				$('#stop').prop('disabled', true);
				if (lastbar == null) {
					alert('خطأ مجهول');
					consoleLog('حدث خطأ مجهول تواصل معي على <a href="mailto:alaa13212@gmail.com">alaa13212@gmail.com</a>', 'rtl');
					return true;
				}
				if (code === 0) {
					lastbar.addClass('bar-success');
					consoleLog('تم التحميل بنجاح', 'rtl');
				} else {
					lastbar.addClass('bar-danger');
					alertBox('فشل التحميل', 'التحميل توقف بشكل مفاجئ، قد يكون فشل الرجاء التأكد من سلامة الملفات', 'danger');
					consoleLog('التحميل توقف بشكل مفاجئ، قد يكون فشل الرجاء التأكد من سلامة الملفات', 'rtl');
				}
				return lastbar.parent('.progress').removeClass('active progress-striped work');
			});
		});
		return $('#test').click(function(e) {
			if (window.dragWin != null) {
				return window.dragWin.close();
			} else {
				window.dragWin = gui.Window.open('drag.html', {
					toolbar : false,
					icon : "/usr/share/icons/hicolor/128x128/apps/youtube-dl-ui.png",
					width : 60,
					height : 50,
					frame : false,
					"always-on-top" : true,
					show_in_taskbar : false,
					x : 0,
					y : 130
				});
				window.dragWin.on('closed', function() {
					var _ref;
					window.dragWin = null;
					return ( _ref = window.mainWin) != null ? _ref.show() :
					void 0;
				});
				window.dragWin.on('loaded', function() {
					return dragWin.window.mainWin = window.mainWin;
				});
				return window.mainWin.hide();
			}
		});
	});

}).call(this);
